{"version":3,"names":["_events","require","_lodash","_backoff","_interopRequireDefault","ownKeys","e","r","t","_Object$keys","_Object$getOwnPropertySymbols","o","filter","_Object$getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","Object","forEach","_defineProperty2","default","_Object$getOwnPropertyDescriptors","_Object$defineProperties","_Object$defineProperty","retry","_len","params","Array","_key","options","defaults","backoff","delay","maxAttempts","strategyOptions","initialDelay","maxDelay","_apply","retryDecorator","target","prop","descriptor","value","wrap","retryExecutor","fn","_this","_len2","args","_key2","emitter","EventEmitter","promise","_promise","resolve","reject","call","cb","innerPromise","isFunction","on","emit","bind","then","res","catch","reason","Error","err","setStrategy","ExponentialStrategy","failAfter","start","key","callback","_typeof2","prototype"],"sources":["retry.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {EventEmitter} from 'events';\n\nimport {defaults, isFunction, wrap} from 'lodash';\nimport backoff from 'backoff';\n\n/* eslint max-nested-callbacks: [0] */\n\n/**\n * Makes a promise-returning method retryable according to the specified backoff\n * pattern\n * @param {Object} options\n * @param {boolean} options.backoff\n * @param {number} options.delay\n * @param {number} options.initialDelay\n * @param {number} options.maxAttempts\n * @param {number} options.maxDelay\n *\n * @returns {Function}\n */\nexport default function retry(...params) {\n  let options = params[0] || {};\n\n  options = {...options};\n  defaults(options, {\n    backoff: true,\n    delay: 1,\n    maxAttempts: 3,\n  });\n\n  let strategyOptions;\n\n  if (options.backoff) {\n    strategyOptions = {\n      initialDelay: options.delay,\n      maxDelay: options.maxDelay,\n    };\n  } else {\n    strategyOptions = {\n      initialDelay: 1,\n      maxDelay: 1,\n    };\n  }\n\n  if (params.length === 3) {\n    return Reflect.apply(retryDecorator, null, params);\n  }\n\n  return retryDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function retryDecorator(target, prop, descriptor) {\n    descriptor.value = wrap(descriptor.value, function retryExecutor(fn, ...args) {\n      const emitter = new EventEmitter();\n      const promise = new Promise((resolve, reject) => {\n        // backoff.call is not Function.prototype.call; it's an unfortunate naming\n        // collision.\n        /* eslint prefer-reflect: [0] */\n        const call = backoff.call(\n          (cb) => {\n            /* eslint no-invalid-this: [0] */\n            const innerPromise = Reflect.apply(fn, this, args);\n\n            if (isFunction(innerPromise.on)) {\n              innerPromise.on('progress', emitter.emit.bind(emitter, 'progress'));\n              innerPromise.on('upload-progress', emitter.emit.bind(emitter, 'upload-progress'));\n              innerPromise.on('download-progress', emitter.emit.bind(emitter, 'download-progress'));\n            }\n\n            return innerPromise\n              .then((res) => {\n                cb(null, res);\n              })\n              .catch((reason) => {\n                if (!reason) {\n                  reason = new Error('retryable method failed without providing an error object');\n                }\n                cb(reason);\n              });\n          },\n          (err, res) => {\n            if (err) {\n              return reject(err);\n            }\n\n            return resolve(res);\n          }\n        );\n\n        call.setStrategy(new backoff.ExponentialStrategy(strategyOptions));\n        if (options.maxAttempts) {\n          call.failAfter(options.maxAttempts - 1);\n        }\n\n        call.start();\n      });\n\n      promise.on = function on(key, callback) {\n        emitter.on(key, callback);\n\n        return promise;\n      };\n\n      return promise;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"],"mappings":"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"}