{"version":3,"names":["_btoa","_interopRequireDefault","require","_httpCore","_nodeRandomName","_uuid","ownKeys","e","r","t","_Object$keys","_Object$getOwnPropertySymbols","o","filter","_Object$getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","Object","forEach","_defineProperty2","default","_Object$getOwnPropertyDescriptors","_Object$defineProperties","_Object$defineProperty","getClientCredentials","_ref","clientId","clientSecret","orgId","idbrokerUrl","machineAccount","machinePassword","request","method","uri","concat","json","body","uid","password","then","res","form","assertion","BearerToken","grant_type","scope","self_contained_token","client_id","client_secret","headers","authorization","btoa","token_type","access_token","createTestUser","options","undefined","process","env","WEBEX_CLIENT_ID","WEBEX_CLIENT_SECRET","WHISTLER_MACHINE_ACCOUNT","randomName","WHISTLER_MACHINE_PASSWORD","uuid","v4","IDBROKER_BASE_URL","WHISTLER_TEST_ORG_ID","whistlerServiceUrl","WHISTLER_API_SERVICE_URL","reservationGroup","userScopes","Error","qs","isAccessTokenRequired","responseMetaData","ciPassword","emailAddress","name","displayName","webExUserName","token","ciAccessToken","reservationUrl","removeTestUser"],"sources":["whistler.js"],"sourcesContent":["import btoa from 'btoa';\nimport {request} from '@webex/http-core';\nimport randomName from 'node-random-name';\nimport uuid from 'uuid';\n\n/**\n * Fetches credentials/access_token to talk to the whistler endpoint\n *\n * @param {Object} options\n * @param {string} options.clientId\n * @param {string} options.clientSecret\n * @param {string} options.idbrokerUrl\n * @param {string} options.orgId\n * @param {string} options.machineAccount\n * @param {string} options.machinePassword\n * @private\n * @returns {Promise<string>}\n */\nconst getClientCredentials = ({\n  clientId,\n  clientSecret,\n  orgId,\n  idbrokerUrl,\n  machineAccount,\n  machinePassword,\n}) =>\n  request({\n    method: 'POST',\n    uri: `${idbrokerUrl}/idb/token/${orgId}/v2/actions/GetBearerToken/invoke`,\n    json: true,\n    body: {\n      uid: machineAccount,\n      password: machinePassword,\n    },\n  })\n    .then((res) =>\n      request({\n        method: 'POST',\n        uri: `${idbrokerUrl}/idb/oauth2/v1/access_token`,\n        json: true,\n        form: {\n          assertion: res.body.BearerToken,\n          grant_type: 'urn:ietf:params:oauth:grant-type:saml2-bearer',\n          scope: 'webexsquare:get_conversation webexsquare:admin',\n          self_contained_token: true,\n          client_id: clientId,\n          client_secret: clientSecret,\n        },\n        headers: {\n          // Note: we can't request's auth hash here because this endpoint expects\n          // us to send the auth header *without including \"Basic \"* before the\n          // token string\n          // authorization: `Basic + ${btoa(`${clientId}:${clientSecret}`)}`\n          authorization: btoa(`${clientId}:${clientSecret}`),\n        },\n      })\n    )\n    .then((res) => `${res.body.token_type} ${res.body.access_token}`);\n\n/**\n * @typedef {Object} TestUserObject\n * @property {string} password\n * @property {string} emailAddress\n * @property {string} displayName\n * @property {string} token\n * @property {string} reservationUrl\n * @property {object} responseMetaData - whistler given properties\n */\n\n/**\n * @typedef {Object} CreateUserOptions\n * @param {Object} [options]\n * @param {string} [whistlerServiceUrl] defaults to WHISTLER_API_SERVICE_URL\n * @param {string} [options.clientId] defaults to WEBEX_CLIENT_ID\n * @param {string} [options.clientSecret] defaults to WEBEX_CLIENT_SECRET\n * @param {string} [options.idbrokerUrl] defaults to IDBROKER_BASE_URL\n * @param {string} [options.orgId] organization ID to create the user under\n * @param {string} [options.machineAccount] defaults to WHISTLER_MACHINE_ACCOUNT\n * @param {string} [options.machinePassword] defaults to WHISTLER_MACHINE_PASSWORD\n */\n\n/**\n * Creates a test user\n * @param {CreateUserOptions} options\n * @returns {Promise.<TestUserObject>}\n */\nexport default function createTestUser(options = {}) {\n  const clientId = options.clientId || process.env.WEBEX_CLIENT_ID;\n  const clientSecret = options.clientSecret || process.env.WEBEX_CLIENT_SECRET;\n  const machineAccount =\n    options.machineAccount || process.env.WHISTLER_MACHINE_ACCOUNT || randomName();\n  const machinePassword =\n    options.machinePassword || process.env.WHISTLER_MACHINE_PASSWORD || `${uuid.v4()}zAY1*`;\n  const idbrokerUrl = options.idbrokerUrl || process.env.IDBROKER_BASE_URL;\n  const orgId = options.orgId || process.env.WHISTLER_TEST_ORG_ID;\n  const whistlerServiceUrl = options.whistlerServiceUrl || process.env.WHISTLER_API_SERVICE_URL;\n  const {reservationGroup, userScopes} = options;\n\n  if (!clientId) {\n    throw new Error('options.clientId or process.env.WEBEX_CLIENT_ID must be defined');\n  }\n\n  if (!clientSecret) {\n    throw new Error('options.clientSecret or process.env.WEBEX_CLIENT_SECRET must be defined');\n  }\n\n  if (!machineAccount) {\n    throw new Error(\n      'options.machineAccount or process.env.WHISTLER_MACHINE_ACCOUNT must be defined'\n    );\n  }\n\n  if (!machinePassword) {\n    throw new Error(\n      'options.machinePassword or process.env.WHISTLER_MACHINE_PASSWORD must be defined'\n    );\n  }\n  if (!idbrokerUrl) {\n    throw new Error('options.idbrokerUrl or process.env.IDBROKER_BASE_URL must be defined');\n  }\n\n  if (!orgId) {\n    throw new Error('options.orgId or process.env.WHISTLER_TEST_ORG_ID must be defined');\n  }\n\n  if (!whistlerServiceUrl) {\n    throw new Error(\n      'options.whistlerServiceUrl or process.env.WHISTLER_API_SERVICE_URL must be defined'\n    );\n  }\n\n  // For reservation groups and user scopes\n  // Please check https://confluence-eng-gpk2.cisco.com/conf/pages/viewpage.action?spaceKey=LOCUS&title=Whistler+APIs#WhistlerAPIs-GET/reservations/testUser\n  return getClientCredentials({\n    clientId,\n    clientSecret,\n    machineAccount,\n    machinePassword,\n    idbrokerUrl,\n    orgId,\n  })\n    .then((authorization) =>\n      request({\n        method: 'GET',\n        uri: `${whistlerServiceUrl}/reservations/testUser`,\n        qs: {\n          reservationGroup,\n          userScopes,\n          isAccessTokenRequired: true,\n        },\n        headers: {\n          authorization,\n        },\n      })\n    )\n    .then((res) => ({\n      password: res.body.responseMetaData.ciPassword,\n      emailAddress: res.body.responseMetaData.name,\n      displayName: res.body.responseMetaData.webExUserName,\n      token: res.body.responseMetaData.ciAccessToken,\n      reservationUrl: res.body.reservationUrl,\n      ...res.body.responseMetaData,\n    }));\n}\n\n/**\n *\n * @param {Object} options\n * @returns {Promise}\n */\nexport function removeTestUser(options = {}) {\n  return request({\n    method: 'DELETE',\n    headers: {\n      authorization: `Bearer ${options.token}`,\n    },\n    uri: options.reservationUrl,\n  });\n}\n"],"mappings":"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"}