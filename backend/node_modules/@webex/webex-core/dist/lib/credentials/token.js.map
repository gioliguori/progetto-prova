{"version":3,"names":["_lodash","require","_common","_commonTimers","_webexHttpError","_interopRequireDefault","_webexPlugin","_scope","_grantErrors","_interopRequireWildcard","_dec","_obj","_getRequireWildcardCache","e","_WeakMap","r","t","__esModule","_typeof","default","has","get","n","__proto__","a","_Object$defineProperty","_Object$getOwnPropertyDescriptor2","u","Object","prototype","hasOwnProperty","call","i","set","ownKeys","_Object$keys","_Object$getOwnPropertySymbols","o","filter","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty2","_Object$getOwnPropertyDescriptors","_Object$defineProperties","processGrantError","res","statusCode","_promise","reject","ErrorConstructor","grantErrors","select","body","error","OAuthError","WebexHttpError","_res","Token","WebexPlugin","extend","oneFlight","keyFactory","scope","derived","canAuthorize","deps","fn","access_token","isExpired","canDownscope","config","client_id","canRefresh","inBrowser","refresh_token","refreshCallback","client_secret","expires","_isExpired","_string","token_type","concat","namespace","props","expires_in","refresh_token_expires","refresh_token_expires_in","type","session","previousToken","downscope","_this","logger","info","Error","trace","diffScopes","sortScope","webex","request","method","uri","tokenUrl","addAuthHeader","form","grant_type","token","self_contained_token","then","_assign","parent","initialize","_this2","attrs","undefined","options","_apply","_now","safeSetTimeout","refresh","_this3","promise","resolve","redirect_uri","auth","user","pass","sendImmediately","shouldRefreshAccessToken","obj","pick","process","env","NODE_ENV","revoke","unset","catch","_this4","revokeUrl","token_type_hint","_this$_filterSetParam","_filterSetParameters","_this$_filterSetParam2","_slicedToArray2","includes","_attrs$access_token$s","split","_attrs$access_token$s2","now","toString","validate","_this5","service","resource","reason","convApi","CONVERSATION_SERVICE","CONVERSATION_SERVICE_URL","headers","authorization","version","_applyDecoratedDescriptor2","_getOwnPropertyDescriptor","_default","exports"],"sources":["token.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {pick} from 'lodash';\nimport {inBrowser, oneFlight} from '@webex/common';\nimport {safeSetTimeout} from '@webex/common-timers';\n\nimport WebexHttpError from '../webex-http-error';\nimport WebexPlugin from '../webex-plugin';\n\nimport {sortScope, diffScopes} from './scope';\nimport grantErrors, {OAuthError} from './grant-errors';\n\n/* eslint-disable camelcase */\n\n/**\n * Parse response from CI and converts to structured error when appropriate\n * @param {WebexHttpError} res\n * @private\n * @returns {GrantError}\n */\nfunction processGrantError(res) {\n  if (res.statusCode !== 400) {\n    return Promise.reject(res);\n  }\n\n  const ErrorConstructor = grantErrors.select(res.body.error);\n\n  if (ErrorConstructor === OAuthError && res instanceof WebexHttpError) {\n    return Promise.reject(res);\n  }\n  if (!ErrorConstructor) {\n    return Promise.reject(res);\n  }\n\n  return Promise.reject(new ErrorConstructor(res._res || res));\n}\n\n/**\n * @class\n */\nconst Token = WebexPlugin.extend({\n  derived: {\n    /**\n     * Indicates if this token can be used in an auth header. `true` iff\n     * {@link Token#access_token} is defined and {@link Token#isExpired} is\n     * false.\n     * @instance\n     * @memberof Token\n     * @readonly\n     * @type {boolean}\n     */\n    canAuthorize: {\n      deps: ['access_token', 'isExpired'],\n      fn() {\n        return !!this.access_token && !this.isExpired;\n      },\n    },\n\n    /**\n     * Indicates that this token can be downscoped. `true` iff\n     * {@link config.credentials.client_id} is defined and if\n     * {@link Token#canAuthorize} is true\n     *\n     * Note: since {@link config} is not evented, we can't listen for changes to\n     * {@link config.credentials.client_id}. As such,\n     * {@link config.credentials.client_id} must always be set before\n     * instantiating a {@link Token}\n     * @instance\n     * @memberof Token\n     * @readonly\n     * @type {boolean}\n     */\n    canDownscope: {\n      deps: ['canAuthorize'],\n      fn() {\n        return this.canAuthorize && !!this.config.client_id;\n      },\n    },\n\n    /**\n     * Indicates if this token can be refreshed. `true` iff\n     * {@link Token@refresh_token} is defined and\n     * {@link config.credentials.refreshCallback()} is defined\n     *\n     * Note: since {@link config} is not evented, we can't listen for changes to\n     * {@link config.credentials.refreshCallback()}. As such,\n     * {@link config.credentials.refreshCallback()} must always be set before\n     * instantiating a {@link Token}\n     * @instance\n     * @memberof Token\n     * @readonly\n     * @type {boolean}\n     */\n    canRefresh: {\n      deps: ['refresh_token'],\n      fn() {\n        if (inBrowser) {\n          return !!this.refresh_token && !!this.config.refreshCallback;\n        }\n\n        return !!this.refresh_token && !!this.config.client_secret;\n      },\n    },\n\n    /**\n     * Indicates if this `Token` is expired. `true` iff {@link Token#expires} is\n     * defined and is less than {@link Date.now()}.\n     * @instance\n     * @memberof Token\n     * @readonly\n     * @type {boolean}\n     */\n    isExpired: {\n      deps: ['expires', '_isExpired'],\n      fn() {\n        // in order to avoid setting `cache:false`, we'll use a private property\n        // and a timer rather than comparing to `Date.now()`;\n        return !!this.expires && this._isExpired;\n      },\n    },\n\n    /**\n     * Cache for toString()\n     * @instance\n     * @memberof Token\n     * @private\n     * @readonly\n     * @type {string}\n     */\n    _string: {\n      deps: ['access_token', 'token_type'],\n      fn() {\n        if (!this.access_token || !this.token_type) {\n          return '';\n        }\n\n        return `${this.token_type} ${this.access_token}`;\n      },\n    },\n  },\n\n  namespace: 'Credentials',\n\n  props: {\n    /**\n     * Used for indexing in the credentials userTokens collection\n     * @instance\n     * @memberof Token\n     * @private\n     * @type {string}\n     */\n    scope: 'string',\n    /**\n     * @instance\n     * @memberof Token\n     * @type {string}\n     */\n    access_token: 'string',\n    /**\n     * @instance\n     * @memberof Token\n     * @type {number}\n     */\n    expires: 'number',\n    /**\n     * @instance\n     * @memberof Token\n     * @type {number}\n     */\n    expires_in: 'number',\n    /**\n     * @instance\n     * @memberof Token\n     * @type {string}\n     */\n    refresh_token: 'string',\n    /**\n     * @instance\n     * @memberof Token\n     * @type {number}\n     */\n    refresh_token_expires: 'number',\n    /**\n     * @instance\n     * @memberof Token\n     * @type {number}\n     */\n    refresh_token_expires_in: 'number',\n    /**\n     * @default \"Bearer\"\n     * @instance\n     * @memberof Token\n     * @type {string}\n     */\n    token_type: {\n      default: 'Bearer',\n      type: 'string',\n    },\n  },\n\n  session: {\n    /**\n     * Used by {@link Token#isExpired} to avoid doing a Date comparison.\n     * @instance\n     * @memberof Token\n     * @private\n     * @type {boolean}\n     */\n    _isExpired: {\n      default: false,\n      type: 'boolean',\n    },\n    /**\n     * Handle to the previous token that we'll revoke when we refresh this\n     * token. The idea is to keep allow two valid tokens when a refresh occurs;\n     * we don't want revoke a token that's in the middle of being used, so when\n     * we do a token refresh, we won't revoke the token being refreshed, but\n     * we'll revoke the previous one.\n     * @instance\n     * @memberof Token\n     * @private\n     * @type {Object}\n     */\n    previousToken: {\n      type: 'state',\n    },\n  },\n\n  @oneFlight({\n    keyFactory(scope) {\n      return scope;\n    },\n  })\n  /**\n   * Uses this token to request a new Token with a subset of this Token's scopes\n   * @instance\n   * @memberof Token\n   * @param {string} scope\n   * @returns {Promise<Token>}\n   */\n  downscope(scope) {\n    this.logger.info(`token: downscoping token to ${scope}`);\n\n    if (this.isExpired) {\n      this.logger.info('token: request received to downscope expired access_token');\n\n      return Promise.reject(new Error('cannot downscope expired access token'));\n    }\n\n    if (!this.canDownscope) {\n      if (this.config.client_id) {\n        this.logger.info('token: request received to downscope invalid access_token');\n      } else {\n        this.logger.trace('token: cannot downscope without client_id');\n      }\n\n      return Promise.reject(new Error('cannot downscope access token'));\n    }\n\n    if (diffScopes(scope, this.config.scope) !== '') {\n      return Promise.reject(\n        new Error(\n          `new scope (${scope}) is not subset of the available scopes (${this.config.scope})`\n        )\n      );\n    }\n\n    // Since we're going to use scope as the index in our token collection, it's\n    // important scopes are always deterministically specified.\n    if (scope) {\n      scope = sortScope(scope);\n    }\n\n    // Ideally, we could depend on the service to communicate this error, but\n    // all we get is \"invalid scope\", which, to the lay person, implies\n    // something wrong with *one* of the scopes, not the whole thing.\n    if (scope === sortScope(this.config.scope)) {\n      return Promise.reject(new Error('token: scope reduction requires a reduced scope'));\n    }\n\n    return this.webex\n      .request({\n        method: 'POST',\n        uri: this.config.tokenUrl,\n        addAuthHeader: false,\n        form: {\n          grant_type: 'urn:cisco:oauth:grant-type:scope-reduction',\n          token: this.access_token,\n          scope,\n          client_id: this.config.client_id,\n          self_contained_token: true,\n        },\n      })\n      .then((res) => {\n        this.logger.info(`token: downscoped token to ${scope}`);\n\n        return new Token(Object.assign(res.body, {scope}), {parent: this.parent});\n      });\n  },\n\n  /**\n   * Initializer\n   * @instance\n   * @memberof Token\n   * @param {Object} [attrs={}]\n   * @param {Object} [options={}]\n   * @see {@link WebexPlugin#initialize()}\n   * @returns {Token}\n   */\n  initialize(attrs = {}, options = {}) {\n    Reflect.apply(WebexPlugin.prototype.initialize, this, [attrs, options]);\n\n    if (typeof attrs === 'string') {\n      this.access_token = attrs;\n    }\n\n    if (!this.access_token) {\n      throw new Error('`access_token` is required');\n    }\n\n    // We don't want the derived property `isExpired` to need {cache:false}, so\n    // we'll set up a timer the runs when this token should expire.\n    if (this.expires) {\n      if (this.expires < Date.now()) {\n        this._isExpired = true;\n      } else {\n        safeSetTimeout(() => {\n          this._isExpired = true;\n        }, this.expires - Date.now());\n      }\n    }\n  },\n\n  @oneFlight\n  /**\n   * Refreshes this Token. Relies on\n   * {@link config.credentials.refreshCallback()}\n   * @instance\n   * @memberof Token\n   * @returns {Promise<Token>}\n   */\n  refresh() {\n    if (!this.canRefresh) {\n      throw new Error('Not enough information available to refresh this access token');\n    }\n\n    let promise;\n\n    if (inBrowser) {\n      if (!this.config.refreshCallback) {\n        throw new Error('Cannot refresh access token without refreshCallback');\n      }\n\n      promise = Promise.resolve(this.config.refreshCallback(this.webex, this));\n    }\n\n    return (\n      promise ||\n      this.webex\n        .request({\n          method: 'POST',\n          uri: this.config.tokenUrl,\n          form: {\n            grant_type: 'refresh_token',\n            redirect_uri: this.config.redirect_uri,\n            refresh_token: this.refresh_token,\n          },\n          auth: {\n            user: this.config.client_id,\n            pass: this.config.client_secret,\n            sendImmediately: true,\n          },\n          shouldRefreshAccessToken: false,\n        })\n        .then((res) => res.body)\n    )\n      .then((obj) => {\n        if (!obj) {\n          throw new Error('token: refreshCallback() did not produce an object');\n        }\n        // If the authentication server did not send back a refresh token, copy\n        // the current refresh token and related values to the response (note:\n        // at time of implementation, CI never sends a new refresh token)\n        if (!obj.refresh_token) {\n          Object.assign(\n            obj,\n            pick(this, 'refresh_token', 'refresh_token_expires', 'refresh_token_expires_in')\n          );\n        }\n\n        // If the new token is the same as the previous token, then we may have\n        // found a bug in CI; log the details and reject the Promise\n        if (this.access_token === obj.access_token) {\n          this.logger.error('token: new token matches current token');\n          // log the tokens if it is not production\n          if (process.env.NODE_ENV !== 'production') {\n            this.logger.error('token: current token:', this.access_token);\n            this.logger.error('token: new token:', obj.access_token);\n          }\n\n          return Promise.reject(new Error('new token matches current token'));\n        }\n\n        if (this.previousToken) {\n          this.previousToken.revoke();\n          this.unset('previousToken');\n        }\n\n        obj.previousToken = this;\n        obj.scope = this.scope;\n\n        return new Token(obj, {parent: this.parent});\n      })\n      .catch(processGrantError);\n  },\n\n  @oneFlight\n  /**\n   * Revokes this token and unsets its local properties\n   * @instance\n   * @memberof Token\n   * @returns {Promise}\n   */\n  revoke() {\n    if (this.isExpired) {\n      this.logger.info('token: already expired, not making making revocation request');\n\n      return Promise.resolve();\n    }\n\n    if (!this.canAuthorize) {\n      this.logger.info('token: no longer valid, not making revocation request');\n\n      return Promise.resolve();\n    }\n\n    // FIXME we need to use the user token revocation endpoint to revoke a token\n    // without a client_secret, but it doesn't current support using a token to\n    // revoke itself\n    // Note: I'm not making a canRevoke property because there should be changes\n    // coming to the user token revocation endpoint that allow us to do this\n    // correctly.\n    if (!this.config.client_secret) {\n      this.logger.info('token: no client secret available, not making revocation request');\n\n      return Promise.resolve();\n    }\n\n    this.logger.info('token: revoking access token');\n\n    return this.webex\n      .request({\n        method: 'POST',\n        uri: this.config.revokeUrl,\n        form: {\n          token: this.access_token,\n          token_type_hint: 'access_token',\n        },\n        auth: {\n          user: this.config.client_id,\n          pass: this.config.client_secret,\n          sendImmediately: true,\n        },\n        shouldRefreshAccessToken: false,\n      })\n      .then(() => {\n        this.unset(['access_token', 'expires', 'expires_in', 'token_type']);\n        this.logger.info('token: access token revoked');\n      })\n      .catch(processGrantError);\n  },\n\n  set(...args) {\n    // eslint-disable-next-line prefer-const\n    let [attrs, options] = this._filterSetParameters(...args);\n\n    if (!attrs.token_type && attrs.access_token && attrs.access_token.includes(' ')) {\n      const [token_type, access_token] = attrs.access_token.split(' ');\n\n      attrs = {...attrs, access_token, token_type};\n    }\n    const now = Date.now();\n\n    if (!attrs.expires && attrs.expires_in) {\n      attrs.expires = now + attrs.expires_in * 1000;\n    }\n\n    if (!attrs.refresh_token_expires && attrs.refresh_token_expires_in) {\n      attrs.refresh_token_expires = now + attrs.refresh_token_expires_in * 1000;\n    }\n\n    if (attrs.scope) {\n      attrs.scope = sortScope(attrs.scope);\n    }\n\n    return Reflect.apply(WebexPlugin.prototype.set, this, [attrs, options]);\n  },\n\n  /**\n   * Renders the token object as an HTTP Header Value\n   * @instance\n   * @memberof Token\n   * @returns {string}\n   * @see {@link Object#toString()}\n   */\n  toString() {\n    if (!this._string) {\n      throw new Error('cannot stringify Token');\n    }\n\n    return this._string;\n  },\n\n  /**\n   * Uses a non-producation api to return information about this token. This\n   * method is primarily for tests and will throw if NODE_ENV === production\n   * @instance\n   * @memberof Token\n   * @private\n   * @returns {Promise}\n   */\n  validate() {\n    if (process.env.NODE_ENV === 'production') {\n      throw new Error('Token#validate() must not be used in production');\n    }\n\n    return this.webex\n      .request({\n        method: 'POST',\n        service: 'conversation',\n        resource: 'users/validateAuthToken',\n        body: {\n          token: this.access_token,\n        },\n      })\n      .catch((reason) => {\n        if ('statusCode' in reason) {\n          return Promise.reject(reason);\n        }\n        this.logger.info(\"REMINDER: If you're investigating a network error here, it's normal\");\n\n        // If we got an error that isn't a WebexHttpError, assume the problem is\n        // that we don't have the wdm plugin loaded and service/resource isn't\n        // a valid means of identifying a request.\n        const convApi =\n          process.env.CONVERSATION_SERVICE ||\n          process.env.CONVERSATION_SERVICE_URL ||\n          'https://conv-a.wbx2.com/conversation/api/v1';\n\n        return this.webex.request({\n          method: 'POST',\n          uri: `${convApi}/users/validateAuthToken`,\n          body: {\n            token: this.access_token,\n          },\n          headers: {\n            authorization: `Bearer ${this.access_token}`,\n          },\n        });\n      })\n      .then((res) => res.body);\n  },\n});\n\nexport default Token;\n"],"mappings":"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"}